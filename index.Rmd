---
title: "Intro to R and FAQ for Planners"
author: "Michael Fichman"
date: "1/4/2022"
output: 
  html_document:
    toc: true
    toc_float: true
    code_download: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

*For years, I've been teaching data analysis, statistical modeling, and spatial analysis to Urban Planning and Spatial Analytics graduate students using the software language R. It's always a challenge to get students started with some basics so that we can move quickly to applied methods and concepts.*

*This is a working document designed to give a basic introduction to R and compile frequently asked questions about basic operations. This isn't really a "coding" tutorial, it's a starter kit that demonstrates some simple Excel or ArcGIS-like tasks - loading spreadsheets and spatial data, creating new columns of data, summarizing and querying data, making charts and maps. *

*This document will be updated on an ongoing basis - apologies if it looks like a construction site at times).*

*Use the table of contents at left to navigate through the document - the simplest topics are first (e.g. "What is R?"). There are references to other books and materials at the end of the doc.*

**Michael Fichman**

*Lecturer, Department of City and Regional Planning*

*Interim Program Director, Masters of Urban Spatial Analytics*

*Researcher, PennPraxis*

*Data Scientist - Center for Safe Mobility*

*University of Pennsylvania Weitzman School of Design*

# Getting Started with R

## What is R?

R is a programming language you can use to do stuff that you can do in Excel, or ArcGIS, or stats software like SAS... but (with some practice) faster, better, and more efficiently. 

You can load data in spreadsheet form, make new columns, summarize it, make charts, make maps. You can load spatial data and use R as a GIS. You can make statistical models.  You can also do way more complicated stuff too. *Most importantly, you can set up routines or workflows to let you repeat processes that in other software would take lots of clicks and steps.*

It's "open source," which means it is written and maintained by a community of people like you and me. That also means that sometimes, things will go wrong and there isn't always a manual to consult.

If you've never programmed before, that's OK, you're in the right place.

## What is R Studio?

I run R code and do projects in R Studio, which is like a viewer for R. You can write code to load and manipulate data. You can see plots and data sets that you've loaded using R Studio. 

## Installing R and R Studio for Windows and Mac. 

1.	Install R: Go to [https://cran.r-project.org/bin/windows/base/](https://cran.r-project.org/bin/windows/base/)
2.	Click on your operating system (Windows, MAC, Linux) and follow directions to DL the most recent version of R – which is 4.1.1 as of this writing.
3.	DL and run the .exe file to install
4.	Install R Studio: Go to [http://www.rstudio.com](http://www.rstudio.com), click on “Download RStudio” and follow the directions for your operating system. 
5.	Open R studio by clicking on the icon, R will run inside the R Studio user interface.

## R Studio Orientation

Now open up R Studio and let's take a look at some of the components.

### The Console

You can type and execute code in the console.

I could type something like `myName <- "Michael"` into the console, and it would create a variable called `myName` that is equal to the character string "Michael" in my "environment."

Go ahead, try it.

```{r michael}

myName <- "Michael"

```

### The Environment

This is where you can see the data sets and other things you've loaded into R to work on. If I load an excel spreadsheet into R using `read_excel`, I could say something like `myData <- read_excel("filepath_on_my_computer.xlsx")` it will show up in my environment as a thing called `myData`.

You can clear the environment by going to the `Session` dropdown and saying `Clear Workspace`.

You can also save your environment or load up an old one from a project you were working on.

### The Code window

If you load up a .R or .rmd file - two types of R files, they will show up as tabs in your code window.

If I give you some code, you can execute it a piece at a time by copying-and-pasting into the console, or highlighting code and hitting `ctrl+Enter` to run it.

If you are writing code, you can save your code as either a .R file (just plain code), or a .rmd file (a Markdown file, like what you are reading now, which is something you can write to present code or analysis.)

### The Plotting / Files / Packages etc Window

-If you make charts or plots - they show up in this window.

-The "Files" tab is a place to graphically look through file trees on your computer.

-You can consult the "Packages" or "Help" tabs to find documentation about different functions and packages in the R world. (More about packages later)

# Data and Coding Basics

How do you "run code" in R?

Usually, I will give you a bunch of code in class, and you will have to adapt that code for a project you are doing. Eventually, you will write some of your own code - but *most people cut and paste stuff* and switch variable names and input data sets around. That's how I do much of my work - I grab things from my code base I've generated over the years. So don't worry about writing things from scratch.

- Code with a `#` in front of it is called "commented code." This stuff doesn't execute it's where you make notes.

- Code without the `#` will run - either as written in the console or by hitting ctrl+enter on code the code window

```{r commented}

# This code doesn't do anything, but the next line does
print('hello world')

```

R is case sensitive - many of your issues can be resolved by checking your syntax. You might get some kind of error because you created a data set called `derp` and you try to call it in the code with `DERP`. Happens *all the time*.

TUTORIAL:

**If this is your first time using R, you might want to try out a .R script called `running_code_in_R.R` which [you can find here](https://github.com/mafichman/R_FAQ_For_Planners/blob/main/R/running_code_in_R.R). It has some simple code and simple operations you can try - download the .R file, load it into your R Studio and follow the instructions to create some simple objects.**

## Naming Variables and Data Sets

Most pieces of data you load into R or create with R will have a name. If you load in a spreadsheet, you will want to give it a name so it shows up in my R environment.  You can assign information to a variable using this sign "<-"

You can have all kinds of data objects:

- A data frame: a matrix of data with column names, basically like an excel spreadsheet (much more on this later)

- A vector: a list of items, denoted with the letter c, like this:
```{r myVector}
myVector <- c("A", "B", "C")
```
- A character: some things treated as text, denoted with "" quotes around it.

```{r myVariable}
myVariable <- "derp"
```
- A number: can be in the form of an integer or a double (a floating point number).

```{r myNumber}
myNumber <- 10
```

## NA Data

There are numbers, characters, and other data types. There are also `NA` data - missing data - these are tricky. You can't do arithmetic on these.

Look at the example below. We create a vector of numeric data called `vector1` which is just numbers, and then we ask its median. That works.

Then we create one called `vector2` with some NA in there, it doesn't work to take the median there.

```{r vector1}
vector1 <- c(1, 4, 6, 7, 10)

median(vector1)
```

```{r vector2}
vector2 <- c(1, 4, 6, NA, 10)

median(vector2)
```

# Installing and Loading Packages

A lot of the things you will want to do with R will require loading packages. "Base R" is basic R - there are a bunch of functions it does. Since R is open source, lots of people have developed their own cool packages that do additional stuff.

A package is a set of functions - some of them make graphics, some handle spatial data. You will almost always start your session by loading some packages.

The first time you use a package on your computer, you can load it with the command `install.packages`, like this:

```{r install_pkg, eval=FALSE, include=TRUE}
install.packages('tidyverse')
```

If you have already installed a package on your computer, you can load it into your environment using the `library` command.

```{r load_pkg ,message = FALSE, warning = FALSE}
library(tidyverse)
```

Packages all come with documentation - lists of functions in these packages have little vignettes that tell you how to use them.  Check that out in the "Packages" tab in your R Studio environment to see these, or just google package names or function names to find the documentation.

## The Tidyverse

The `tidyverse`, which we loaded in the previous code chunk, is a group of important packages which are used to wrangle data, make graphics, load data, handle dates, handle text. Better yet, these projects are coordinated by their developers, so they all work nicely together.

For work in our class, you should load up the tidyverse on every project. Most of my code doesn't work without it.

# Loading Data 

Most projects will start with you loading some spreadsheet-like data - from a survey you conducted, from an excel sheet, from the Census' website, from a shapefile that I gave you for class. For non-spatial data, these spreadsheet-like data will be in a format called a "data frame" (or as a variant called a "tibble).

There are a lot of file types you can load, and some of them have their own functions, like you can read in Excel data with the `read_excel` function in the `readxl` package. Later on I will show you how to read in a .shp. (You can read more about these data import functionalities [here.](https://raw.githubusercontent.com/rstudio/cheatsheets/main/data-import.pdf))

There are several ways to load data into your R environment.

## Loading Data From Your Computer

You can load data from your computer in one of two ways, either by going to `File / Import Data Set` in a dropdown menu R Studio, and clicking on the relevant options (note that "From txt" will let you load a csv, txt, tsv or other similar file types), or by doing it with code, like this:

```{r myData_cpu, eval = FALSE}
myData <- read.csv("filepath/onMyComputer/fileName.csv")
```

## Loading Data from the Web

You can load data from the web, like from Google Drive or Github, using the same kind of syntax. Here we load a csv from the web:

```{r myData_url}
myData <- read.csv("https://raw.githubusercontent.com/mafichman/R_FAQ_For_Planners/main/data/someCensusData.csv")
```

## Viewing Data

Now that you've loaded in some data, you can examine them in several ways. You can `View(myData)` and see a visual representation of the data in an excel-like way, or you can `glimpse` your data frame.

`glimpse` will tell you what data types the columns are (character, numeric, etc), let you see some samples of the data, and let you see how many rows and columns the data contain.

```{r glimpse_myData}
glimpse(myData)
```

# Manipulating Data with dplyr

`dplyr` is the core data wrangling package in "tidy" R. You can use functions from `dplyr` to manipulate data frames. 

You can make new columns, and remove or rename columns from your data frame. You can summarize data (e.g. what is the sum of all the rows in a given column). You can filter data to keep only rows that meet some criteria.

It does lots of other stuff too.

There is a handy guide for all the dplyr data tools at [R Studio's dplyr cheat sheet](https://raw.githubusercontent.com/rstudio/cheatsheets/main/data-transformation.pdf).

## Using the "Pipe"

*Very important*, to what I'm about to show you from here on out is a thingy called a "pipe" - `%>%` - which is an object you put in your code to chain functions together and make kind of data-wrangling recipes.

To understand what the pipe does, think about the following "recipe" like this: I make an `omlette` by taking a data frame called `eggs` and applying the functions `scramble` and `fry`

`omlette <- eggs %>% scramble() %>% fry()`

OK, keep that in mind while we look at `dplyr` commands.

## Dplyr commands

Let's use a few basic `dplyr` commands to wrangle our dataframe `myData`.

### Mutate

`mutate` makes a new column. I am going to *overwrite* `myData` - making a new version that has a new column in it. Each row of the data frame represents a census tract, and I'd like to see what the difference is in tract population between 2010 and 2016. I'll call this new column `pop_change` and set its value equal to `total_pop.2016` minus `total_pop.2010`. Note the pipe used to "chain" the mutate statement in there.

```{r mutate_first}

myData <- myData %>%
  mutate(pop_change = total_pop.2016 - total_pop.2010)

```

Did it work? Try typing `View(myData)` or `glimpse(myData)` into your console.

I'm now going to create a second variable called `pop_change_positive` using `mutate`. If the population change was positive, I'm going to call set this variable equal to `TRUE` - I'll do an `ifelse` statement to make it's value contingent on the value of `pop_change`.

```{r mutate_second}

myData <- myData %>%
  mutate(pop_change_positive = ifelse(pop_change > 0, TRUE, FALSE))

```

### Filter

`filter` lets you reduce your data frame based on some criteria. I'd like to create a new data frame called `population_loss` that consists only of census tracts in `myData` that lost population (e.g. pop_change_positive == FALSE).


```{r filter}
population_loss <- myData %>%
  filter(pop_change_positive == FALSE)
```

I can do this kind of filtering based on lots of criteria.

### Select

`select` keeps only certain columns that you want to keep.

I'm going to make a new data frame, called `twoVariables` that consists of only the columns `NAME.y` and `GEOID` from the data frame `myData`

```{r select}
twoVariables <- myData %>%
  select(NAME.y, GEOID)
```

### Rename

`rename` changes the names of your columns. I'd like to rename the column from the data frame `twoVariables` called `NAME.y` to be called just `NAME`

```{r rename}
twoVariables <- twoVariables %>%
  rename(NAME = NAME.y)
```

## Summarizing Data

You'll often want to know about the characteristics or central tendencies of your data. Using the `group_by` and `summarize` commands you can do lots of this.

Here are some examples - notice I'm not creating new data frames here.

First, let's just find out what the median `pop_change` was between 2010 and 2016 for Philadelphia census tracts.

```{r summarize_1}
myData %>%
  summarize(median_pop_change = median(pop_change))
```

What if we want to know how one type of tract versus another varied in terms of `pop_change`? We can group our data into categories using `group_by` and then summarize.

For tracts for which `pop_change_positive` (remember we created this column as a TRUE/FALSE - was there population change between 2010 and 2016?) what is the median `pop_change`?

```{r summarize_2}
myData %>%
  group_by(pop_change_positive) %>%
  summarize(median_pop_change = median(pop_change))
```

## Joining Data

# Making Plots with ggplot2

TBD incl - Facets, Wide data and long data

# Tidycensus

Grab some data with tidycensus.
Reference tidycensus tutorial

# Vector GIS With sf

TBD incl -Loading Data, Making Maps with ggplot2, Projections, Vector Geoprocessing
Reference geoprocessing tutorial

# R Markdown

TBD

I will probably be asking you to turn in assignments using R Markdown. Markdown is a way to present your code-based projects as a more polished document (you're reading a markdown right now!). For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

If you want to see how markdown works - you can find a download button at the top right of this document and download the code that was used to make this.

TBD incl - Global Options, Chunk Options, kable tables

# Querying APIs

TBD incl - Socrata and REST API query functionalities for R.

# Other Spatial Packages

Mapview, Leaflet, osmdata, raster

# Project Workflows - Github and R Projects

Github, R Projects, Writing Readable Code

# Resources and texts

## Troubleshooting - How to ask a question

It's super important to know how to ask a good question on the internet or on the class forum about some issue you are having. Googling around is a really good way to find help - so you can google something about the error you are having, or look on [https://stackoverflow.com](https://stackoverflow.com), which is a community of people doing Q&A and troubleshooting.

You can look up details about the functions you are using in R using the `??` command in your console like this:

`??read.csv`

You can also check out the documentation about the packages, functions and the arguments they take in the Packages tab in the Viewer window in R Studio.

If you are going to ask a question on the class forum, include some code, and details about your problem - like the data sources that you tried to use and how they look. This allows somebody to reproduce the issue on their own, or at least understand it. Here's an example:

EXAMPLE GOES HERE

## R Cheat Sheets

R Studio's website has some really good [cheat sheets](https://www.rstudio.com/resources/cheatsheets/) with simple walkthroughs of basic functions in some core packages

- [ggplot2 - graphics and plots](https://raw.githubusercontent.com/rstudio/cheatsheets/main/data-visualization.pdf)

- [dplyr - manipulating data frames](https://raw.githubusercontent.com/rstudio/cheatsheets/main/data-transformation.pdf)

- [sf - vector GIS](https://raw.githubusercontent.com/rstudio/cheatsheets/main/sf.pdf)

- [R markdown - document publishing, includes knitr](https://raw.githubusercontent.com/rstudio/cheatsheets/main/rmarkdown.pdf)

- [lubridate - dates and times](https://raw.githubusercontent.com/rstudio/cheatsheets/main/lubridate.pdf)

- [(readr - loading data)](https://raw.githubusercontent.com/rstudio/cheatsheets/main/data-import.pdf)

## Style Guides

Handy tips for making your code readable

- [R Style Guide](https://google.github.io/styleguide/Rguide.html)

- [Tidyverse Style Guide](https://style.tidyverse.org/)

## Books

If you're in a class with me - these books are likely to be among the required or supplemental readings. They are all fantastic, open source, and extremely, extremely useful. Here they are in "bookdown" form for free.

- [R for Data Science - Hadley Wickham](https://r4ds.had.co.nz/) - Text for CPLN 675

- [Public Policy Analytics - Ken Steif](https://urbanspatial.github.io/PublicPolicyAnalytics/) - Text for MUSA 508

- [Data Visualization - Kieran Healy](https://socviz.co/)

- [Geocomputation with R - Robin Lovelace](https://geocompr.robinlovelace.net/)

- [Analyzing US Census Data - Kyle Walker](https://walker-data.com/census-r/)

- [Geospatial Health Data - Paula Moraga](https://www.paulamoraga.com/book-geospatial/)

# FAQ

Common Q&A will go here